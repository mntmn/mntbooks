<html>
  <head>
    <%= erb :style %>
  </head>
  <body>
    <%= erb :menu, :locals => { :active => :book, :prefix => prefix } %>
      <table>
        <tr>
          <th>Date</th>
          <th>Cr</th>
          <th>Amt</th>
          <th>Debit</th>
          <th>Credit</th>
          <th class="details">Details</th>
          <th>Receipt</th>
          <th>Comment</th>
        </tr>
        <% months.keys.each do |mk| %>
        <% months[mk][:bookings].each do |b| %>
        <tr class="<%= b[:css_class] %>" id="<%= b[:id] %>">
          <td class="date"><%= b[:date] %></td>
          <td class="amount"><%= b[:currency] %></td>
          <td class="amount"><%= '%.2f' % (b[:amount_cents]/100.0) %></td>
          <td><input type="text" id="book-<%= b[:id] %>-debit" value="<%= b[:debit_account] %>"></td>
          <td><input type="text" id="book-<%= b[:id] %>-credit" value="<%= b[:credit_account] %>"></td>
          
          <td class="details">
            <b title="<%= b[:raw] %>"><%= b[:fields][:trailer]||"Bank?" %></b><br>

            <% if b[:type] == :paypal %>
              <a href="https://www.paypal.com/activity/payment/<%= b[:id] %>" target="_blank">üîç</a>
              <%= b[:fields][:email] %>
            <% end %>

            <%= b[:details] %>
          </td>
          
          <td>
            <ul>
            <% b[:receipt_urls].each do |r| %>
            <li><a href="<%= r %>"><%= r.gsub("/pdf/","") %></a></li>
            <% end %>
            </ul>
          </td>
          <td>
            <input type="text" id="book-<%= b[:id] %>-comment" value="<%= b[:comment] %>">
            <button onclick="saveBooking('<%= b[:id] %>')">Save</button>
          </td>
        </tr>
        <% end %>
        <tr class="month-row">
          <td class="date"></td>
          <td></td>
          <td class="amount"><%= '%.2f' % (months[mk][:sum_cents]/100.0) %></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
        <% end %>
      </table>

      <script>
        function saveBooking(id) {
          key = "book-"+id
          
          data = {
            id: id,
            debit_account:  document.getElementById(key+"-debit").value,
            credit_account: document.getElementById(key+"-credit").value,
            comment: document.getElementById(key+"-comment").value
          }

          console.log("saveBooking:", data)

          var url = "book/"+id
          var xhr = new XMLHttpRequest()
          xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
              console.log(xhr.response)
              try {
                var obj = JSON.parse(xhr.response)
                alert("Booking updated: "+obj.id)
                //location.href="<%= prefix %>/invoices"
              } catch (e) {
                alert("Sorry, an error occured: "+xhr.response)
              }
            }
          }
          xhr.open("POST", url, true)
          xhr.setRequestHeader("Content-type", "application/json")
          xhr.send(JSON.stringify(data))
        }
      </script>
  </body>
</html>
